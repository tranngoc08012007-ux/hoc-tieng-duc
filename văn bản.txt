<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Deutsch-Pro-Library v3</title>
    <style>
        :root { --der: #007bff; --die: #dc3545; --das: #28a745; --verb: #6f42c1; --adj: #e67e22; --adv: #1abc9c; --phrase: #95a5a6; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 220px; background: #2c3e50; color: white; padding: 20px; flex-shrink: 0; }
        .menu-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; }
        .menu-item.active { background: #3498db; }
        .main-content { flex: 1; padding: 25px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }

        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { margin: 0; color: #888; font-size: 0.8rem; text-transform: uppercase; }
        .stat-card p { margin: 5px 0 0 0; font-size: 1.5rem; font-weight: bold; color: #2c3e50; }

        /* Collapsible Lib */
        .day-header { background: #34495e; color: white; padding: 12px 20px; border-radius: 8px; margin: 10px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .day-content { display: none; margin-bottom: 20px; }
        .day-content.open { display: block; }
        
        .input-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 550px; margin: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; border-left: 8px solid #ccc; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card.der { border-left-color: var(--der); } .card.die { border-left-color: var(--die); } .card.das { border-left-color: var(--das); }
        .card.Verb { border-left-color: var(--verb); } .card.Phrase { border-left-color: var(--phrase); }
        
        .btn-group-top { position: absolute; top: 8px; right: 8px; display: flex; gap: 8px; }
        .card-btn { cursor: pointer; border: none; background: none; font-size: 16px; color: #bbb; }
        .action-btn { width: 100%; padding: 15px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        
        /* Quiz UI */
        .quiz-container { max-width: 600px; margin: auto; text-align: center; background: white; padding: 30px; border-radius: 15px; }
        .progress-bar { height: 10px; background: #eee; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: #3498db; width: 0%; transition: 0.3s; }
        .quiz-feedback { margin: 15px 0; padding: 15px; border-radius: 8px; display: none; }
        .feedback-error { background: #fdeaea; color: #e74c3c; }
        .feedback-success { background: #eafaf1; color: #27ae60; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="text-align: center;">Ng·ªçc's Deutsch</h2>
        <div class="menu-item active" onclick="showTab('nhap-lieu')">‚ûï Th√™m t·ª´ m·ªõi</div>
        <div class="menu-item" onclick="showTab('thu-vien')">üìö Th∆∞ vi·ªán</div>
        <div class="menu-item" onclick="showTab('on-tap')">üß† √în t·∫≠p</div>
        <hr style="border: 0.5px solid #444; margin: 20px 0;">
        <button onclick="exportData()" style="width:100%; background:none; border:1px solid #777; color:#ccc; cursor:pointer; padding:5px; border-radius:4px; font-size: 0.8rem;">üíæ Sao l∆∞u d·ªØ li·ªáu (.json)</button>
    </div>

    <div class="main-content">
        <div id="nhap-lieu" class="section active">
            <div class="input-card">
                <h2 id="formTitle">Ghi ch√∫ t·ª´ v·ª±ng</h2>
                <input type="hidden" id="editId">
                <select id="wordType" onchange="updateForm()">
                    <option value="Nomen">Danh t·ª´ (Nomen)</option>
                    <option value="Verb">ƒê·ªông t·ª´ (Verb)</option>
                    <option value="Phrase">C·ª•m t·ª´ (Phrase)</option>
                    <option value="Adjektiv">T√≠nh t·ª´</option>
                </select>
                <input type="text" id="german" placeholder="Ti·∫øng ƒê·ª©c...">
                <input type="text" id="vietnamese" placeholder="Nghƒ©a ti·∫øng Vi·ªát...">
                <div id="dynamicFields"></div>
                <textarea id="note" rows="3" placeholder="Ghi ch√∫..."></textarea>
                <button id="saveBtn" class="action-btn" onclick="saveWord()">L∆ØU V√ÄO TH∆Ø VI·ªÜN</button>
                <button id="cancelEdit" style="display:none; background:#95a5a6; width:100%; padding:10px; border:none; color:white; border-radius:6px; margin-top:5px;" onclick="resetForm()">H·ª¶Y CH·ªàNH S·ª¨A</button>
            </div>
        </div>

        <div id="thu-vien" class="section">
            <div class="stats-grid" id="statsGrid"></div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm t·ª´..." onkeyup="renderLib()">
                <select id="filterType" onchange="renderLib()" style="width:200px;">
                    <option value="all">T·∫•t c·∫£ lo·∫°i t·ª´</option>
                    <option value="Nomen">Danh t·ª´</option>
                    <option value="Verb">ƒê·ªông t·ª´</option>
                    <option value="Phrase">C·ª•m t·ª´</option>
                </select>
            </div>
            <div id="libContainer"></div>
        </div>

        <div id="on-tap" class="section">
            <div id="quizSetup" class="input-card">
                <h2>C√†i ƒë·∫∑t √¥n t·∫≠p</h2>
                <label>Ch·∫ø ƒë·ªô:</label>
                <select id="quizMode">
                    <option value="all">√în t·∫≠p t·∫•t c·∫£ c√°c t·ª´</option>
                    <option value="today">Ch·ªâ √¥n t·ª´ c·ªßa ng√†y m·ªõi nh·∫•t</option>
                    <option value="byDate">√în theo ng√†y c·ª• th·ªÉ</option>
                </select>
                <select id="selectQuizDate" style="display:none;"></select>
                <button class="action-btn" style="background: #3498db;" onclick="startQuiz()">B·∫ÆT ƒê·∫¶U</button>
            </div>
            <div id="quizPlay" class="section">
                <div class="quiz-container">
                    <div class="progress-bar"><div id="pFill" class="progress-fill"></div></div>
                    <div id="qCount" style="font-size: 0.8rem; color: #888; margin-bottom:10px;"></div>
                    <div style="font-size: 1.8rem; font-weight: bold; color: #2c3e50; margin-bottom: 20px;" id="qViet"></div>
                    <input type="text" id="qAns" placeholder="Nh·∫≠p ti·∫øng ƒê·ª©c..." autocomplete="off">
                    <div id="qFeedback" class="quiz-feedback"></div>
                    <button id="qNextBtn" class="action-btn" onclick="checkAnswer()">KI·ªÇM TRA</button>
                    <button id="qFinalBtn" class="action-btn" style="display:none; background:#95a5a6;" onclick="showTab('on-tap')">XONG</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myLibrary = JSON.parse(localStorage.getItem('duc_final_v2')) || [];

        function speakGerman(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'de-DE';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        function updateForm() {
            const type = document.getElementById('wordType').value;
            const container = document.getElementById('dynamicFields');
            if (type === 'Nomen') {
                container.innerHTML = `<select id="gender"><option value="der">der</option><option value="die">die</option><option value="das">das</option></select><input id="plural" placeholder="S·ªë nhi·ªÅu">`;
            } else if (type === 'Verb') {
                container.innerHTML = `<input id="praeteritum" placeholder="Pr√§teritum"><input id="perfekt" placeholder="Perfekt">`;
            } else { container.innerHTML = ''; }
        }

        function saveWord() {
            const id = document.getElementById('editId').value;
            const german = document.getElementById('german').value.trim();
            const vietnamese = document.getElementById('vietnamese').value.trim();
            if (!german || !vietnamese) return alert("Thi·∫øu th√¥ng tin!");

            const wordData = {
                id: id ? parseInt(id) : Date.now(),
                date: id ? myLibrary.find(w => w.id == id).date : new Date().toLocaleDateString('vi-VN'),
                type: document.getElementById('wordType').value,
                german: german,
                vietnamese: vietnamese,
                note: document.getElementById('note').value,
                gender: document.getElementById('gender')?.value || '',
                plural: document.getElementById('plural')?.value || '',
                praeteritum: document.getElementById('praeteritum')?.value || '',
                perfekt: document.getElementById('perfekt')?.value || ''
            };

            if (id) {
                const index = myLibrary.findIndex(w => w.id == id);
                myLibrary[index] = wordData;
            } else {
                myLibrary.push(wordData);
            }

            localStorage.setItem('duc_final_v2', JSON.stringify(myLibrary));
            resetForm();
            renderLib();
        }

        function renderStats() {
            const stats = { Total: myLibrary.length, Nomen: 0, Verb: 0, Phrase: 0 };
            myLibrary.forEach(w => { if(stats[w.type] !== undefined) stats[w.type]++; });
            
            document.getElementById('statsGrid').innerHTML = Object.entries(stats).map(([label, val]) => `
                <div class="stat-card"><h3>${label}</h3><p>${val}</p></div>
            `).join('');
        }

        function renderLib() {
            renderStats();
            const container = document.getElementById('libContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('filterType').value;
            container.innerHTML = '';

            let filtered = myLibrary.filter(w => {
                const mSearch = w.german.toLowerCase().includes(search) || w.vietnamese.toLowerCase().includes(search);
                const mFilter = (filter === 'all') || (w.type === filter);
                return mSearch && mFilter;
            });

            const groups = filtered.reduce((acc, w) => {
                acc[w.date] = acc[w.date] || [];
                acc[w.date].push(w);
                return acc;
            }, {});

            const sortedDates = Object.keys(groups).reverse();
            sortedDates.forEach((date, index) => {
                const isFirst = index === 0 && search === '';
                const dayId = `day-${date.replace(/\//g, '-')}`;
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.innerHTML = `<span>üìÖ Ng√†y: ${date} (${groups[date].length} t·ª´)</span> <span>${isFirst ? '‚ñº' : '‚ñ∂'}</span>`;
                dayHeader.onclick = () => {
                    const content = document.getElementById(dayId);
                    content.classList.toggle('open');
                    dayHeader.querySelector('span:last-child').innerText = content.classList.contains('open') ? '‚ñº' : '‚ñ∂';
                };

                const dayContent = document.createElement('div');
                dayContent.id = dayId;
                dayContent.className = `day-content ${isFirst ? 'open' : ''}`;
                
                const grid = document.createElement('div');
                grid.className = 'grid';
                groups[date].forEach(w => {
                    const card = document.createElement('div');
                    card.className = `card ${w.gender || w.type}`;
                    card.innerHTML = `
                        <div class="btn-group-top">
                            <button class="card-btn" onclick="event.stopPropagation(); speakGerman('${w.german.replace(/'/g, "\\'")}')">üîä</button>
                            <button class="card-btn" onclick="event.stopPropagation(); editWord(${w.id})">‚úèÔ∏è</button>
                            <button class="card-btn" onclick="event.stopPropagation(); deleteWord(${w.id})">&times;</button>
                        </div>
                        <span style="font-size:0.7rem; color:#888;">${w.type}</span>
                        <div style="margin-top:5px;"><b>${w.gender ? w.gender + ' ' : ''}${w.german}</b></div>
                        <div>${w.vietnamese}</div>
                    `;
                    grid.appendChild(card);
                });
                dayContent.appendChild(grid);
                container.appendChild(dayHeader);
                container.appendChild(dayContent);
            });
        }

        // --- QUIZ LOGIC ---
        let quizQueue = [], quizIdx = 0, quizWrong = [];
        
        document.getElementById('quizMode').onchange = (e) => {
            document.getElementById('selectQuizDate').style.display = e.target.value === 'byDate' ? 'block' : 'none';
        };

        function startQuiz() {
            const mode = document.getElementById('quizMode').value;
            if (mode === 'all') quizQueue = [...myLibrary];
            else if (mode === 'today') {
                const latestDate = [...new Set(myLibrary.map(w => w.date))].reverse()[0];
                quizQueue = myLibrary.filter(w => w.date === latestDate);
            } else {
                quizQueue = myLibrary.filter(w => w.date === document.getElementById('selectQuizDate').value);
            }

            if (quizQueue.length === 0) return alert("Kh√¥ng c√≥ t·ª´ ƒë·ªÉ √¥n t·∫≠p!");
            quizQueue.sort(() => Math.random() - 0.5);
            quizIdx = 0; quizWrong = [];
            document.getElementById('quizSetup').style.display = 'none';
            document.getElementById('quizPlay').classList.add('active');
            nextQuestion();
        }

        function nextQuestion() {
            if(quizIdx >= quizQueue.length) {
                if(quizWrong.length > 0) {
                    quizQueue = [...quizWrong]; quizWrong = []; quizIdx = 0;
                    alert("√în l·∫°i c√°c t·ª´ b·∫°n ƒë√£ l√†m sai!");
                } else {
                    document.getElementById('qViet').innerText = "Ho√†n th√†nh! üèÜ";
                    document.getElementById('qAns').style.display = 'none';
                    document.getElementById('qNextBtn').style.display = 'none';
                    document.getElementById('qFinalBtn').style.display = 'block';
                    return;
                }
            }
            const q = quizQueue[quizIdx];
            document.getElementById('qViet').innerText = q.vietnamese;
            document.getElementById('qAns').value = '';
            document.getElementById('qAns').focus();
            document.getElementById('qFeedback').style.display = 'none';
            document.getElementById('qNextBtn').innerText = "KI·ªÇM TRA";
            document.getElementById('qNextBtn').onclick = checkAnswer;
            document.getElementById('pFill').style.width = `${(quizIdx/quizQueue.length)*100}%`;
            document.getElementById('qCount').innerText = `T·ª´ ${quizIdx + 1} / ${quizQueue.length}`;
        }

        function checkAnswer() {
            const q = quizQueue[quizIdx];
            const ans = document.getElementById('qAns').value.trim().toLowerCase();
            const correct = (q.gender ? q.gender + " " + q.german : q.german).toLowerCase();
            const feedback = document.getElementById('qFeedback');
            feedback.style.display = 'block';

            if(ans === correct || ans === q.german.toLowerCase()) {
                feedback.className = 'quiz-feedback feedback-success';
                feedback.innerText = "Ch√≠nh x√°c!";
                speakGerman(q.german);
            } else {
                feedback.className = 'quiz-feedback feedback-error';
                feedback.innerHTML = `Sai r·ªìi! ƒê√°p √°n: <b>${correct}</b>`;
                quizWrong.push(q);
            }
            document.getElementById('qNextBtn').innerText = "TI·∫æP THEO";
            document.getElementById('qNextBtn').onclick = () => { quizIdx++; nextQuestion(); };
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(myLibrary));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", `deutsch_lib_${new Date().toLocaleDateString()}.json`);
            dlAnchorElem.click();
        }

        function showTab(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'thu-vien') renderLib();
            if(id === 'on-tap') {
                const dates = [...new Set(myLibrary.map(w => w.date))].reverse();
                document.getElementById('selectQuizDate').innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
                document.getElementById('quizSetup').style.display = 'block';
                document.getElementById('quizPlay').classList.remove('active');
            }
        }

        function deleteWord(id) { if(confirm("X√≥a t·ª´ n√†y?")) { myLibrary = myLibrary.filter(w => w.id !== id); localStorage.setItem('duc_final_v2', JSON.stringify(myLibrary)); renderLib(); } }
        function editWord(id) { /* Gi·ªëng code c≈© nh∆∞ng g·ªçi showTab('nhap-lieu') */ 
            const word = myLibrary.find(w => w.id === id);
            showTab('nhap-lieu');
            document.getElementById('editId').value = word.id;
            document.getElementById('german').value = word.german;
            document.getElementById('vietnamese').value = word.vietnamese;
            document.getElementById('wordType').value = word.type;
            updateForm();
            if(word.gender) document.getElementById('gender').value = word.gender;
            document.getElementById('saveBtn').innerText = "C·∫¨P NH·∫¨T";
            document.getElementById('cancelEdit').style.display = 'block';
        }
        function resetForm() { document.getElementById('editId').value = ''; document.getElementById('german').value = ''; document.getElementById('vietnamese').value = ''; document.getElementById('saveBtn').innerText = "L∆ØU V√ÄO TH∆Ø VI·ªÜN"; document.getElementById('cancelEdit').style.display = 'none'; updateForm(); }

        updateForm();
    </script>
</body>
</html>
